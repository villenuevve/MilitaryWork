<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–Ü—Å—Ç–æ—Ä—ñ—è –≤–∏—è–≤–ª–µ–Ω—å</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/256/2785/2785693.png" type="image/png">
    <script>
        function confirmLogout() {
            return confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏?");
        }
        function confirmDeleteRecord() {
            return confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?");
        }
    </script>
</head>
<body>
    <div class="container fade-in">
        <h1>–Ü—Å—Ç–æ—Ä—ñ—è –≤–∏—è–≤–ª–µ–Ω—å</h1>
        <div class="export-buttons">
            <a href="/export/pdf" class="btn">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF</a>
            <a href="/export/csv" class="btn">üìä –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ CSV</a>
        </div>

        <div class="user-info" style="text-align: right; margin-bottom: 1rem;">
            üë§ {{ username }} ({{ "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä" if role == "admin" else "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á" }})
        </div>
        <div class="top-bar" style="text-align: right; margin-bottom: 1rem;">
            <div class="button-group">
                <a href="/" class="button history">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
                <button type="button" class="button logout" onclick="window.location.href='/logout'">üö™ –í–∏–π—Ç–∏</button>
            </div>
        </div>

        <form method="get" action="/history" class="filter-form">
            <label for="from">–í—ñ–¥:</label>
            <input type="date" name="from" id="from" value="{{ request.query_params.get('from', '') }}">
            
            <label for="to">–î–æ:</label>
            <input type="date" name="to" id="to" value="{{ request.query_params.get('to', '') }}">
        
            <label for="class">–ö–ª–∞—Å —Ç–µ—Ö–Ω—ñ–∫–∏:</label>
            <select name="class" id="class">
                <option value="">–£—Å—ñ</option>
                <option value="ambulance" {% if request.query_params.get('class') == 'ambulance' %}selected{% endif %}>üöë –®–≤–∏–¥–∫–∞</option>
                <option value="fire engine" {% if request.query_params.get('class') == 'fire engine' %}selected{% endif %}>üöí –ü–æ–∂–µ–∂–Ω–∞</option>
                <option value="gas emergency" {% if request.query_params.get('class') == 'gas emergency' %}selected{% endif %}>üõ¢Ô∏è –ì–∞–∑–æ–≤–∞</option>
                <option value="police car" {% if request.query_params.get('class') == 'police car' %}selected{% endif %}>üöì –ü–æ–ª—ñ—Ü–µ–π—Å—å–∫–∞</option>
                <option value="rescue helicopter" {% if request.query_params.get('class') == 'rescue helicopter' %}selected{% endif %}>üöÅ –ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä</option>
            </select>
        
            <button type="submit">
                <span>üîç</span> –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏
            </button>            
        </form>

        {% if role == "admin" %}
            <p>üî¢ –ó–∞–≥–∞–ª–æ–º: {{ total }}</p>
            <p>üìä –°–µ—Ä–µ–¥–Ω—è —Ç–æ—á–Ω—ñ—Å—Ç—å: {{ avg_conf }}%</p>
            <p>üîç –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–ª–∞—Å—ñ–≤: {{ classes|length }}</p>
        {% endif %}

        {% if detections %}
        <table class="detection-table">
            <thead>
                <tr>
                    <th class="sortable">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</th>
                    <th class="sortable">–ö–ª–∞—Å</th>
                    <th class="sortable">–¢–æ—á–Ω—ñ—Å—Ç—å</th>
                    <th class="sortable">GPS</th>
                    <th class="sortable">–î–∞—Ç–∞</th>
                    {% if role == "admin" %}
                    <th>–î–Ü–á</th>
                    {% endif %}
                </tr>
            </thead>                
            <tbody>
                {% for det in detections %}
                <tr>
                    <td>
                        {% if det.image_url %}
                        <img src="/static/predictions/{{ det.image_filename }}" alt="preview" class="thumbnail" />
                        {% else %}
                        üîò
                        {% endif %}
                    </td>
                    <td>{{ det.predicted_class }}</td>
                    <td>{{ "%.2f" | format(det.confidence) }}%</td>
                    <td>{{ det.gps or "‚Äî" }}</td>
                    <td>{{ det.timestamp }}</td>
                    {% if role == "admin" %}
                    <td>
                        <form method="post" action="/delete/{{ det.id }}" onsubmit="return confirmDeleteRecord();">
                            <button class="delete-button">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-message">
            <p>ü§ñ –Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—è. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É!</p>
        </div>
        {% endif %}

        {% if role == "admin" and user_infos %}
        <h2 style="margin-top: 2rem;">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h2>
        <table class="detection-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–Ü–º‚Äô—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</th>
                    <th>–†–æ–ª—å</th>
                    <th>–í–∏—è–≤–ª–µ–Ω—å</th>
                    <th>–î–Ü–á</th>
                </tr>
            </thead>
            <tbody>
                {% for u in user_infos %}
                <tr>
                    <td>{{ u.id }}</td>
                    <td>{{ u.username }}</td>
                    <td>{{ u.role }}</td>
                    <td>{{ u.detections_count }}</td>
                    <td>
                        {% if u.id != current_user_id %}
                        <form action="/admin/delete-user/{{ u.id }}" method="post" onsubmit="return confirmDeleteRecord();">
                            <button type="submit" class="delete-button">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </form>
                        {% else %}
                        <span style="color: gray;">‚Äî</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <a href="/" class="back-btn">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
    </div>
</body>
</html>
